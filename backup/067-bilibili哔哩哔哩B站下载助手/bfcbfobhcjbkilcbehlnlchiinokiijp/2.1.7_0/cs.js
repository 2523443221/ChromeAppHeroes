const internalUrls={zanshang:chrome.runtime.getURL("zanshang.jpeg")},manifest=chrome.runtime.getManifest(),contentScript=(async()=>{const e=(...e)=>{console.log("[B站下载助手]",...e);const t=document.querySelector("#bilibili-helper-host");if(t){const n=t.shadowRoot.querySelector("#bilibliHelperLogs");if(n){const t=`<p>${e.map(e=>{if(e.message)return e.message;if("object"==typeof e)try{return JSON.stringify(e)}catch(t){return e}return e}).join(" ")}</p>`;n.innerHTML+=t}}},t=window.oFetch||window.fetch;e("the fetch is:",t);const n=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!n())return;const i=-1!==window.navigator.userAgent.indexOf("Edg/"),a=()=>/\/video\/(av|bv)[0-9a-zA-Z]+/i.test(window.location.pathname),o=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!a()&&!o())return;class s extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class r{constructor(e,t=0){this.tagHeader=new s(e.buffer,e.byteOffset+t,11),this.tagData=new s(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new s(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new s(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class l{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new s(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new s(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new r(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],i=[0,0],a=[0,0],o=0;for(let r of e){let d=1e3*o;i[0]=a[0],i[1]=a[1],d=Math.max(d,i[0],i[1]);let c=0,p=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new l(new s(n.result)))),n.readAsArrayBuffer(r),n.onerror=t}),g=[];for(let i of p.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),g.push(i.tagHeader,i.tagData,i.previousSize)):(o+=i.getDuration(),c=1,r==e[0]&&(n.push(p.header,p.firstPreviousTagSize),({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(g))}return t.setFloat64(0,o),new Blob(n)}}const d=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),c={credentials:"include"},p=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),g=t=>{if(!t.durl)return-10403===t.code?(t.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",t):void 0!==t.code?t:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:n,accept_description:i}=t;return n.forEach((e,t)=>{h[e]=i[t]}),e("下载链接:"),{code:0,durls:t.durl.map((t,n)=>{e("-"),e(`分段 ${n+1}：`),e("&nbsp;&nbsp;&nbsp;&nbsp;主链接：",t.url),t.backup_url&&t.backup_url.length&&t.backup_url.forEach((t,n)=>{e(`&nbsp;&nbsp;&nbsp;&nbsp;备用链接 ${n+1}：`,t)});const i=new URL(t.url);return i.protocol=window.location.protocol,{url:i.href,size:t.size}}),qualityDescription:h[t.quality]}},h={120:"超清4K",112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},m=()=>"normal"!==localStorage.bilibili_helper_download_mode,u=()=>"off"!==localStorage.bilibili_helper_merge_mode,b=()=>"hide"===localStorage.bilibili_helper_show,f=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},y=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,w=(e,t,n,i)=>{if(0!==n)return"";if(!m())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${f(e.size)})</span></li>\n      `).join("");if(m()&&!u())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${f(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(m()&&u()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${f(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},v=({code:e,title:t,durls:n,message:a,loading:o})=>{let s=document.getElementById("bilibili-helper-host"),r=null;const l=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';s?((r=s.shadowRoot).getElementById("title").innerHTML=o?"加载中"+l:y(t,n,e,a),r.getElementById("durls").innerHTML=o?"":w(n,t,e)):((s=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",s.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,b()?s.classList.add("hide"):s.classList.remove("hide"),s.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 9!important;\n        }\n      </style>",document.body.appendChild(s),(r=s.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n          #bilibliHelperLogs {\n            margin-top: 10px;\n            max-width: 600px;\n            max-height: 400px;\n            overflow: auto;\n            border: 1px solid #ccc;\n            border-radius: 5px;\n            padding: 10px;\n            line-height: 1.2;\n            background: rgb(50,50,50);\n            color: rgb(154,180,90);\n            white-space: normal;\n            word-break: break-all;\n            word-wrap: break-word;\n            font-size: 11px;\n          }\n        </style>\n        <div id="content" ${b()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <p style="margin-bottom: 10px;"><a target="_blank" href="https://docs.qq.com/doc/DQ2lhaWRpS0tubVVF">使用教程及常见问题解答</a></p>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户以及合并下载经常卡住的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${o?"加载中"+l:y(t,n,e,a)}</h3>\n            <ul id="durls">\n              ${o?"":w(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p style="${i?"display:none":""}">\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n            <div id="bilibliHelperLogs">\n              <h4>解析日志：</h4>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${b()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),p=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},g=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};m()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),u()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const h=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),h()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),h()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",h()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",h()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),p(),L(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(g)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),p(),$(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(g))}}),r.addEventListener("click",()=>{b()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(r),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(r)),r.buildDownloadLinks=(()=>{r.getElementById("durls").innerHTML=w(n,t,e)})},x=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},_=(e,n,i)=>{let a=null;return t(e).then(e=>{const t=e.headers.get("content-length"),o=n||parseInt(t,10);let s=0;return a=setInterval(()=>{i(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{a&&clearInterval(a)})},$=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),_(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];x(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),L=(e,t,n,i)=>{if(1===t.length)return $(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${f(t)}) 正在下载`,i.appendChild(a),_(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${f(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${f(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await l.mergeBlobs(Array.from(e));x(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},k=async()=>{if(!n())return;v({loading:!0});const i=await(()=>t(window.location.href,c).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(t=>(e("获取视频信息失败：",t),p())))();if(i.code)return v(i);let s=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||120;if(a()){e("这是一个投稿视频");const n=i.videoData.bvid||i.videoData.aid;let a,o,r=i.videoData.cid;if(e("av:",n,"cid:",r),i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let t=i.videoData.pages[0];e&&e[1]&&(t=i.videoData.pages.find(t=>""+t.page==""+e[1])),a=t.page,o=t.part,r=t.cid}const{code:l,durls:d,qualityDescription:h,message:m}=await((n,i,a=120)=>{const o=n.toLowerCase().startsWith("bv");return t(`//api.bilibili.com/x/player/playurl?cid=${i}&${o?"bvid":"avid"}=${n}&otype=json&qn=${a}`,c).then(e=>e.json()).then(e=>0!==e.code?g(e):g(e.data)).catch(t=>(e("获取下载地址失败：",t),p()))})(n,r,s);if(0===l){let e=`${i.videoData.title}`;a&&o&&(e=`${i.videoData.title}_P${a}_${o}`),v({code:l,title:e,durls:d,message:m})}else v({code:l,message:m})}if(o()){e("这是一个番剧视频");const n=i.epList;let a=-1===i.epId?n[n.length-1].ep_id:i.epId,o=n.find(e=>a===e.ep_id);const r=await d(".episode-item.on"),l=await d(".ep-item.cursor");if(r||l){const e=r||l,t=e.parentElement;let i=Array.from(t.querySelectorAll("li")).findIndex(t=>t===e);const s=await d("#eplist_module .ep-list-progress");s&&(i=+s.textContent.match(/(\d+)\/\d+/)[1]-1),o=n[i],a=o.ep_id||o.id}e("epID:",a,"quality:",s);const{code:h,durls:m,qualityDescription:u,message:b}=await((n,i=120)=>{return t(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${n}&qn=${i}&bsource=`,c).then(e=>e.json()).then(e=>0!==e.code?g(e):g(e.result)).catch(t=>(e("获取下载地址失败：",t),p()))})(a,s);if(0===h){const e=`${i.mediaInfo.title}_${o.index||o.title}_${o.index_title||o.longTitle}`;v({code:h,title:e,durls:m,message:b})}else v({code:h,message:b})}};k();let T=""+window.location.href,S=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if(T!==e&&(T=e,k()),S!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(S).setting_config.defquality)return;S=t,k()}catch(e){}},1e3)}).toString();(e=>{if(-1!==e.location.href.indexOf("bilibili.com/s/video/"))return e.location.replace(e.location.href.replace("/s/","/"));const t=document.createElement("style");t.textContent='[class*="fullscreen"] #bilibili-helper-host {z-index: 9!important;}',document.head.appendChild(t);const n=document.createElement("script"),i=`async()=> {const internalUrls = ${JSON.stringify(internalUrls)};const manifest = ${JSON.stringify(manifest)};`,a=contentScript.replace("async () => {",i).replace("async()=>{",i);n.textContent=`(${a})();`,document.head.appendChild(n)})(window);